#!/bin/bash
# ============================================
# ai-guardrails-init
# Set up pedantic code enforcement for any project
#
# Usage:
#   ai-guardrails-init              # Auto-detect and copy all relevant configs
#   ai-guardrails-init --type rust  # Specify project type
#   ai-guardrails-init --all        # Copy ALL configs (multi-language project)
# ============================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Find script directory and configs path
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIGS_DIR="$SCRIPT_DIR/../configs"
TEMPLATES_DIR="$SCRIPT_DIR/../templates"
LIB_DIR="$SCRIPT_DIR/../lib"

# Check if installed globally
if [[ -d "$HOME/.ai-guardrails/configs" ]]; then
  CONFIGS_DIR="$HOME/.ai-guardrails/configs"
  TEMPLATES_DIR="$HOME/.ai-guardrails/templates"
  LIB_DIR="$HOME/.ai-guardrails/lib"
fi

# Portable sed -i (works on both GNU and BSD/macOS)
sed_inplace() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "$@"
  else
    sed -i "$@"
  fi
}

usage() {
  cat <<EOF
Usage: ai-guardrails-init [OPTIONS]

Set up pedantic code enforcement configs for the current project.

Options:
  --type TYPE        Project type: dotnet, rust, lua, cpp, python, node, go, shell, all
  --all              Copy ALL configs (for multi-language projects)
  --force            Overwrite existing config files
  --no-precommit     Skip pre-commit config
  --pip-audit-pip    Force pip-audit configuration for pip
  --pip-audit-uv     Force pip-audit configuration for uv
  --no-pip-audit     Disable pip-audit hook
  --ci               Install CI workflow (.github/workflows/check.yml)
  --no-ci            Skip CI workflow installation
  --claude-review    Install Claude Code review workflow
  --no-claude-review Skip Claude Code review workflow
  --coderabbit       Install CodeRabbit config (.coderabbit.yaml)
  --no-coderabbit    Skip CodeRabbit config installation
  -h, --help         Show this help

Languages supported (auto-detected or via --type):
  python    Python (ruff.toml)
  rust      Rust (rustfmt.toml)
  dotnet    C#/.NET (Directory.Build.props, .globalconfig)
  cpp       C/C++ (.clang-format)
  lua       Lua (stylua.toml)
  node      TypeScript/JavaScript (biome.json)
  go        Go (uses go.mod)
  shell     Shell scripts (shellcheck + shfmt)

Also installs (for GitHub projects):
  .coderabbit.yaml    CodeRabbit AI reviewer config (assertive + approval workflow)
  check.yml           CI workflow for pre-commit checks
  claude-review.yml   Claude Code review workflow (AI-powered PR review)

Examples:
  ai-guardrails-init                   # Auto-detect project type
  ai-guardrails-init --type rust       # Rust project
  ai-guardrails-init --all             # Multi-language project
  ai-guardrails-init --pip-audit-uv    # Force uv configuration for pip-audit
EOF
}

PROJECT_TYPE=""
FORCE=false
SKIP_PRECOMMIT=false
COPY_ALL=false
PIP_AUDIT_MODE="auto"
INSTALL_CI="auto"
INSTALL_CLAUDE_REVIEW="auto"
INSTALL_CODERABBIT="auto"
detected=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --type)
      PROJECT_TYPE="$2"
      shift 2
      ;;
    --all)
      COPY_ALL=true
      shift
      ;;
    --force)
      FORCE=true
      shift
      ;;
    --no-precommit)
      SKIP_PRECOMMIT=true
      shift
      ;;
    --pip-audit-pip)
      PIP_AUDIT_MODE="pip"
      shift
      ;;
    --pip-audit-uv)
      PIP_AUDIT_MODE="uv"
      shift
      ;;
    --no-pip-audit)
      PIP_AUDIT_MODE="none"
      shift
      ;;
    --ci)
      INSTALL_CI="yes"
      shift
      ;;
    --no-ci)
      INSTALL_CI="no"
      shift
      ;;
    --claude-review)
      INSTALL_CLAUDE_REVIEW="yes"
      shift
      ;;
    --no-claude-review)
      INSTALL_CLAUDE_REVIEW="no"
      shift
      ;;
    --coderabbit)
      INSTALL_CODERABBIT="yes"
      shift
      ;;
    --no-coderabbit)
      INSTALL_CODERABBIT="no"
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      usage
      exit 1
      ;;
  esac
done

# ============================================
# Language detection using Python assembly script
# ============================================

detect_languages() {
  # Use Python assembly script for detection
  python3 "$LIB_DIR/python/assemble_precommit.py" --list-detected 2>/dev/null | cut -d: -f1 | tr '\n' ' '
}

detect_python_deps() {
  # Auto-detect Python dependency management tool
  # Returns: "uv", "pip", or "none"

  if [[ -f "uv.lock" ]]; then
    echo "uv"
  elif [[ -f "requirements.txt" ]]; then
    echo "pip"
  elif [[ -f "pyproject.toml" ]]; then
    # Has pyproject.toml but no uv.lock (already checked above)
    echo "pip"
  else
    echo "none"
  fi
}

configure_pip_audit() {
  local tool="$1"
  local config_file=".pre-commit-config.yaml"

  # pip-audit configuration block to append
  local pip_audit_block=""

  case "$tool" in
    uv)
      # Export uv.lock to requirements.txt for pip-audit compatibility
      if command -v uv &>/dev/null; then
        if uv export --format requirements.txt --output-file requirements-audit.txt --quiet 2>/dev/null; then
          pip_audit_block='
  # pip-audit - CVE scanning for Python dependencies
  - repo: https://github.com/pypa/pip-audit
    rev: v2.10.0
    hooks:
      - id: pip-audit
        name: "python - pip-audit CVE scan"
        args: ["--strict", "--progress-spinner", "off", "-r", "requirements-audit.txt"]'
          echo -e "  ${GREEN}✓ Configured pip-audit for uv (-r requirements-audit.txt)${NC}"
          echo -e "  ${YELLOW}  Note: Re-run 'uv export' after dependency changes${NC}"
        else
          echo -e "  ${YELLOW}⚠ Could not export uv.lock - pip-audit disabled${NC}"
          echo -e "  ${YELLOW}  Run: uv export --format requirements.txt -o requirements-audit.txt${NC}"
          return
        fi
      else
        echo -e "  ${YELLOW}⚠ uv not found - pip-audit disabled${NC}"
        echo -e "  ${YELLOW}  Install uv and run: uv export --format requirements.txt -o requirements-audit.txt${NC}"
        return
      fi
      ;;
    pip)
      if [[ -f "requirements.txt" ]]; then
        pip_audit_block='
  # pip-audit - CVE scanning for Python dependencies
  - repo: https://github.com/pypa/pip-audit
    rev: v2.10.0
    hooks:
      - id: pip-audit
        name: "python - pip-audit CVE scan"
        args: ["--strict", "--progress-spinner", "off", "-r", "requirements.txt"]'
        echo -e "  ${GREEN}✓ Configured pip-audit for pip (-r requirements.txt)${NC}"
      else
        pip_audit_block='
  # pip-audit - CVE scanning for Python dependencies
  - repo: https://github.com/pypa/pip-audit
    rev: v2.10.0
    hooks:
      - id: pip-audit
        name: "python - pip-audit CVE scan"
        args: ["--strict", "--progress-spinner", "off", "."]'
        echo -e "  ${GREEN}✓ Configured pip-audit for pip (current environment)${NC}"
      fi
      ;;
    none)
      echo -e "  ${YELLOW}⚠ pip-audit disabled${NC}"
      echo -e "  ${YELLOW}  Run with --pip-audit-pip or --pip-audit-uv to enable${NC}"
      return
      ;;
  esac

  # Append pip-audit block to config
  if [[ -n "$pip_audit_block" ]]; then
    echo "$pip_audit_block" >>"$config_file"
  fi
}

copy_config() {
  local src="$1"
  local dst="$2"

  if [[ -f "$dst" && "$FORCE" == false ]]; then
    echo -e "  ${YELLOW}⊘ $(basename "$dst") exists (use --force to overwrite)${NC}"
    return
  fi

  if [[ -f "$src" ]]; then
    cp "$src" "$dst"
    echo -e "  ${GREEN}✓ $(basename "$dst")${NC}"
  else
    echo -e "  ${RED}✗ $(basename "$src") not found${NC}"
  fi
}

copy_configs_for_language() {
  local lang="$1"

  case "$lang" in
    python)
      copy_config "$CONFIGS_DIR/ruff.toml" "ruff.toml"
      ;;
    rust)
      copy_config "$CONFIGS_DIR/rustfmt.toml" "rustfmt.toml"
      ;;
    dotnet)
      copy_config "$CONFIGS_DIR/Directory.Build.props" "Directory.Build.props"
      copy_config "$CONFIGS_DIR/.globalconfig" ".globalconfig"
      ;;
    cpp)
      copy_config "$CONFIGS_DIR/.clang-format" ".clang-format"
      ;;
    lua)
      copy_config "$CONFIGS_DIR/stylua.toml" "stylua.toml"
      ;;
    node)
      copy_config "$CONFIGS_DIR/biome.json" "biome.json"
      ;;
    go | shell)
      # No config files needed (uses tool defaults or go.mod)
      ;;
    *)
      echo -e "  ${YELLOW}⚠ Unknown language: $lang${NC}"
      ;;
  esac
}

echo -e "${BLUE}AI Guardrails - Pedantic Code Enforcement${NC}"
echo

# Determine what to copy
if [[ "$COPY_ALL" == true ]]; then
  PROJECT_TYPE="all"
elif [[ -z "$PROJECT_TYPE" ]]; then
  detected=$(detect_languages)
  if [[ -n "$detected" ]]; then
    # Count detected types
    type_count=$(echo "$detected" | wc -w)
    if [[ $type_count -gt 1 ]]; then
      echo -e "${BLUE}Detected multiple languages:${NC}$detected"
    else
      PROJECT_TYPE=$(echo "$detected" | xargs)
      echo -e "${BLUE}Detected project type:${NC} $PROJECT_TYPE"
    fi
  fi
fi

if [[ -z "$PROJECT_TYPE" && -z "$detected" ]]; then
  echo -e "${YELLOW}No language detected - installing base config only (.editorconfig)${NC}"
  echo -e "${YELLOW}Use --type or --all to install language-specific configs${NC}"
fi

echo

# Always copy .editorconfig
echo -e "${GREEN}Copying configs...${NC}"
copy_config "$CONFIGS_DIR/.editorconfig" ".editorconfig"

# Copy language-specific configs
if [[ "$PROJECT_TYPE" == "all" ]]; then
  # Copy all configs
  copy_config "$CONFIGS_DIR/ruff.toml" "ruff.toml"
  copy_config "$CONFIGS_DIR/biome.json" "biome.json"
  copy_config "$CONFIGS_DIR/.clang-format" ".clang-format"
  copy_config "$CONFIGS_DIR/stylua.toml" "stylua.toml"
  copy_config "$CONFIGS_DIR/rustfmt.toml" "rustfmt.toml"
  copy_config "$CONFIGS_DIR/Directory.Build.props" "Directory.Build.props"
  copy_config "$CONFIGS_DIR/.globalconfig" ".globalconfig"
elif [[ -n "$PROJECT_TYPE" ]]; then
  # Single language specified
  copy_configs_for_language "$PROJECT_TYPE"
else
  # Multiple languages detected - copy configs for each
  for lang in $detected; do
    copy_configs_for_language "$lang"
  done
fi

# Copy pre-commit config using Python assembly
if [[ "$SKIP_PRECOMMIT" == false ]]; then
  echo
  echo -e "${GREEN}Setting up pre-commit...${NC}"

  # Track whether we should configure pip-audit
  CONFIGURE_PIP_AUDIT=false
  if [[ ! -f ".pre-commit-config.yaml" || "$FORCE" == true ]]; then
    CONFIGURE_PIP_AUDIT=true
  fi

  # Build language args for assembly script
  LANG_ARGS=""
  if [[ "$PROJECT_TYPE" == "all" ]]; then
    LANG_ARGS="--languages python rust dotnet cpp lua node go shell"
  elif [[ -n "$PROJECT_TYPE" ]]; then
    LANG_ARGS="--languages $PROJECT_TYPE"
  fi
  # If neither set, let assembly script auto-detect

  # Generate pre-commit config
  if [[ -f ".pre-commit-config.yaml" && "$FORCE" == false ]]; then
    echo -e "  ${YELLOW}⊘ .pre-commit-config.yaml exists (use --force to overwrite)${NC}"
  else
    # shellcheck disable=SC2086
    if python3 "$LIB_DIR/python/assemble_precommit.py" $LANG_ARGS --output ".pre-commit-config.yaml" 2>/dev/null; then
      echo -e "  ${GREEN}✓ .pre-commit-config.yaml${NC}"

      # Configure pip-audit if Python detected
      if [[ "$CONFIGURE_PIP_AUDIT" == true ]]; then
        # Check if Python is in the detected/specified languages
        HAS_PYTHON=false
        if [[ "$PROJECT_TYPE" == "all" || "$PROJECT_TYPE" == "python" ]]; then
          HAS_PYTHON=true
        elif [[ -n "$detected" ]] && echo "$detected" | grep -qw "python"; then
          HAS_PYTHON=true
        fi

        if [[ "$HAS_PYTHON" == true ]]; then
          if [[ "$PIP_AUDIT_MODE" == "auto" ]]; then
            PIP_AUDIT_MODE=$(detect_python_deps)
          fi
          configure_pip_audit "$PIP_AUDIT_MODE"
        fi
      fi
    else
      echo -e "  ${RED}✗ Failed to generate .pre-commit-config.yaml${NC}"
    fi
  fi

  # Copy format-and-stage.sh to project for local hook reference
  mkdir -p ".ai-guardrails/hooks"
  if [[ -f "$LIB_DIR/hooks/format-and-stage.sh" ]]; then
    cp "$LIB_DIR/hooks/format-and-stage.sh" ".ai-guardrails/hooks/"
    chmod +x ".ai-guardrails/hooks/format-and-stage.sh"
    echo -e "  ${GREEN}✓ format-and-stage.sh${NC}"

    # Update pre-commit config to use the local path
    if [[ -f ".pre-commit-config.yaml" ]]; then
      sed_inplace 's|entry: lib/hooks/format-and-stage.sh|entry: .ai-guardrails/hooks/format-and-stage.sh|g' ".pre-commit-config.yaml"
    fi
  fi

  # Install pre-commit hooks if available
  if command -v pre-commit &>/dev/null; then
    if [[ -d ".git" ]]; then
      # Fix potential hooksPath issue (empty hooksPath disables hooks)
      if git config core.hooksPath 2>/dev/null | grep -q '^$'; then
        git config --unset core.hooksPath 2>/dev/null || true
        echo -e "  ${YELLOW}⚠ Fixed empty core.hooksPath setting${NC}"
      fi

      if pre-commit install 2>/dev/null; then
        echo -e "  ${GREEN}✓ pre-commit hooks installed${NC}"
      fi
      if pre-commit install --hook-type commit-msg 2>/dev/null; then
        echo -e "  ${GREEN}✓ commit-msg hook installed${NC}"
      fi

      # Verify hooks are properly installed
      if [[ -f ".git/hooks/pre-commit" ]]; then
        echo -e "  ${GREEN}✓ Hooks verified in .git/hooks/${NC}"
      else
        echo -e "  ${RED}✗ Warning: pre-commit hook not found in .git/hooks/${NC}"
        echo -e "  ${YELLOW}  Try: pre-commit install --force${NC}"
      fi
    fi
  else
    echo -e "  ${YELLOW}Note: Install pre-commit to activate hooks:${NC}"
    echo "    pip install pre-commit && pre-commit install"
  fi
fi

# Add .ai-guardrails to gitignore
if [[ -d ".git" ]]; then
  if ! grep -q "^\.ai-guardrails" .gitignore 2>/dev/null; then
    echo ".ai-guardrails/" >>.gitignore
    echo -e "  ${GREEN}✓ Added .ai-guardrails/ to .gitignore${NC}"
  fi
fi

# Install CI workflow
if [[ "$INSTALL_CI" == "auto" && -d ".git" ]]; then
  # Auto: install if .github directory exists or this looks like a GitHub project
  if [[ -d ".github" ]] || git remote -v 2>/dev/null | grep -q "github.com"; then
    INSTALL_CI="yes"
  fi
fi

if [[ "$INSTALL_CI" == "yes" ]]; then
  echo
  echo -e "${GREEN}Setting up CI workflow...${NC}"
  mkdir -p .github/workflows
  if [[ -f "$TEMPLATES_DIR/workflows/check.yml" ]]; then
    copy_config "$TEMPLATES_DIR/workflows/check.yml" ".github/workflows/check.yml"
  else
    echo -e "  ${YELLOW}⚠ CI workflow template not found${NC}"
  fi
fi

# Install Claude Code review workflow
if [[ "$INSTALL_CLAUDE_REVIEW" == "auto" && -d ".git" ]]; then
  # Auto: install if .github directory exists or this looks like a GitHub project
  if [[ -d ".github" ]] || git remote -v 2>/dev/null | grep -q "github.com"; then
    INSTALL_CLAUDE_REVIEW="yes"
  fi
fi

if [[ "$INSTALL_CLAUDE_REVIEW" == "yes" ]]; then
  echo
  echo -e "${GREEN}Setting up Claude Code review...${NC}"
  mkdir -p .github/workflows
  if [[ -f "$TEMPLATES_DIR/workflows/claude-review.yml" ]]; then
    copy_config "$TEMPLATES_DIR/workflows/claude-review.yml" ".github/workflows/claude-review.yml"
    echo -e "  ${BLUE}→ Note: This workflow requires OIDC auth (must be on default branch first)${NC}"
    echo -e "  ${BLUE}→ Or provide anthropic_api_key in workflow secrets${NC}"
  else
    echo -e "  ${YELLOW}⚠ Claude review workflow template not found${NC}"
  fi
fi

# Install CodeRabbit config
if [[ "$INSTALL_CODERABBIT" == "auto" && -d ".git" ]]; then
  # Auto: install if this looks like a GitHub project
  if [[ -d ".github" ]] || git remote -v 2>/dev/null | grep -q "github.com"; then
    INSTALL_CODERABBIT="yes"
  fi
fi

if [[ "$INSTALL_CODERABBIT" == "yes" ]]; then
  echo
  echo -e "${GREEN}Setting up CodeRabbit...${NC}"
  if [[ -f "$TEMPLATES_DIR/.coderabbit.yaml" ]]; then
    copy_config "$TEMPLATES_DIR/.coderabbit.yaml" ".coderabbit.yaml"
    echo -e "  ${BLUE}→ Customize path_instructions in .coderabbit.yaml for your project${NC}"
  else
    echo -e "  ${YELLOW}⚠ CodeRabbit config template not found${NC}"
  fi
fi

# Update CLAUDE.md or AGENTS.md with guardrails rules
GUARDRAILS_MARKER="## AI Guardrails - Code Standards"
GUARDRAILS_TEMPLATE="$TEMPLATES_DIR/CLAUDE.md.guardrails"

if [[ -f "$GUARDRAILS_TEMPLATE" ]]; then
  echo
  echo -e "${GREEN}Setting up agent instructions...${NC}"

  append_guardrails() {
    local file="$1"
    if grep -q "$GUARDRAILS_MARKER" "$file" 2>/dev/null; then
      echo -e "  ${YELLOW}⊘ $file already has guardrails section${NC}"
      return
    fi
    echo "" >>"$file"
    cat "$GUARDRAILS_TEMPLATE" >>"$file"
    echo -e "  ${GREEN}✓ Appended guardrails rules to $file${NC}"
  }

  if [[ -f "AGENTS.md" ]]; then
    append_guardrails "AGENTS.md"
  fi

  if [[ -f "CLAUDE.md" ]]; then
    append_guardrails "CLAUDE.md"
  elif [[ ! -f "AGENTS.md" ]]; then
    # Create CLAUDE.md only if neither exists
    echo "# Project Instructions" >"CLAUDE.md"
    cat "$GUARDRAILS_TEMPLATE" >>"CLAUDE.md"
    echo -e "  ${GREEN}✓ Created CLAUDE.md with guardrails rules${NC}"
  fi
fi

echo
echo -e "${GREEN}Pedantic code enforcement initialized!${NC}"
echo
echo "Configs installed enforce:"
echo "  • Consistent formatting (EditorConfig + language formatters)"
echo "  • Required type annotations"
echo "  • Required documentation (docstrings, XML comments)"
echo "  • Strict static analysis (warnings as errors)"
echo
echo "Run pre-commit on all files:"
echo "  pre-commit run --all-files"
