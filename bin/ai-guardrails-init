#!/bin/bash
# ============================================
# ai-guardrails-init
# Set up pedantic code enforcement for any project
#
# Usage:
#   ai-guardrails-init              # Auto-detect and copy all relevant configs
#   ai-guardrails-init --type rust  # Specify project type
#   ai-guardrails-init --all        # Copy ALL configs (multi-language project)
# ============================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Find script directory and configs path
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIGS_DIR="$SCRIPT_DIR/../configs"
TEMPLATES_DIR="$SCRIPT_DIR/../templates"

# Check if installed globally
if [[ -d "$HOME/.ai-guardrails/configs" ]]; then
  CONFIGS_DIR="$HOME/.ai-guardrails/configs"
  TEMPLATES_DIR="$HOME/.ai-guardrails/templates"
fi

# Portable sed -i (works on both GNU and BSD/macOS)
sed_inplace() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "$@"
  else
    sed -i "$@"
  fi
}

usage() {
  cat <<EOF
Usage: ai-guardrails-init [OPTIONS]

Set up pedantic code enforcement configs for the current project.

Options:
  --type TYPE        Project type: dotnet, rust, lua, cpp, python, node, all
  --all              Copy ALL configs (for multi-language projects)
  --force            Overwrite existing config files
  --no-precommit     Skip pre-commit config
  --pip-audit-pip    Force pip-audit configuration for pip
  --pip-audit-uv     Force pip-audit configuration for uv
  --no-pip-audit     Disable pip-audit hook
  -h, --help         Show this help

Configs installed per type:
  all       .editorconfig, pre-commit-config.yaml, all language configs
  dotnet    .editorconfig, Directory.Build.props, .globalconfig
  rust      .editorconfig, rustfmt.toml
  cpp       .editorconfig, .clang-format
  lua       .editorconfig, stylua.toml
  python    .editorconfig, ruff.toml
  node      .editorconfig, biome.json

Examples:
  ai-guardrails-init                   # Auto-detect project type
  ai-guardrails-init --type rust       # Rust project
  ai-guardrails-init --all             # Multi-language project
  ai-guardrails-init --pip-audit-uv    # Force uv configuration for pip-audit
EOF
}

PROJECT_TYPE=""
FORCE=false
SKIP_PRECOMMIT=false
COPY_ALL=false
PIP_AUDIT_MODE="auto"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --type)
      PROJECT_TYPE="$2"
      shift 2
      ;;
    --all)
      COPY_ALL=true
      shift
      ;;
    --force)
      FORCE=true
      shift
      ;;
    --no-precommit)
      SKIP_PRECOMMIT=true
      shift
      ;;
    --pip-audit-pip)
      PIP_AUDIT_MODE="pip"
      shift
      ;;
    --pip-audit-uv)
      PIP_AUDIT_MODE="uv"
      shift
      ;;
    --no-pip-audit)
      PIP_AUDIT_MODE="none"
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      usage
      exit 1
      ;;
  esac
done

# Auto-detect project type
detect_project_type() {
  local types=""

  if find . -maxdepth 1 \( -name "*.csproj" -o -name "*.sln" \) -print -quit | grep -q .; then
    types="$types dotnet"
  fi
  if [[ -f "Cargo.toml" ]]; then
    types="$types rust"
  fi
  if find . -maxdepth 1 \( -name "*.rockspec" -o -name "*.lua" \) -print -quit | grep -q . || [[ -d "lua" ]]; then
    types="$types lua"
  fi
  if [[ -f "CMakeLists.txt" ]] || [[ -f "Makefile" ]] || find . -maxdepth 1 \( -name "*.cpp" -o -name "*.c" -o -name "*.h" -o -name "*.hpp" \) -print -quit | grep -q .; then
    types="$types cpp"
  fi
  if [[ -f "pyproject.toml" ]] || [[ -f "setup.py" ]] || [[ -f "requirements.txt" ]] || find . -maxdepth 1 -name "*.py" -print -quit | grep -q .; then
    types="$types python"
  fi
  if [[ -f "package.json" ]] || [[ -f "tsconfig.json" ]]; then
    types="$types node"
  fi

  echo "$types"
}

detect_python_deps() {
  # Auto-detect Python dependency management tool
  # Returns: "uv", "pip", or "none"

  if [[ -f "uv.lock" ]]; then
    echo "uv"
  elif [[ -f "requirements.txt" ]]; then
    echo "pip"
  elif [[ -f "pyproject.toml" ]]; then
    # Has pyproject.toml but no uv.lock (already checked above)
    echo "pip"
  else
    echo "none"
  fi
}

configure_pip_audit() {
  local tool="$1"
  local config_file=".pre-commit-config.yaml"

  case "$tool" in
    uv)
      # pip-audit --locked requires PEP 751 lockfiles, not uv.lock
      # Export uv.lock to requirements.txt for pip-audit compatibility
      if command -v uv &>/dev/null; then
        if uv export --format requirements.txt --output-file requirements-audit.txt --quiet 2>/dev/null; then
          # Uncomment pip-audit and configure for exported requirements
          sed_inplace 's/^#   \(- repo: https:\/\/github.com\/pypa\/pip-audit\)/  \1/' "$config_file"
          sed_inplace 's/^#     \(rev: v2.10.0\)/    \1/' "$config_file"
          sed_inplace 's/^#     \(hooks:\)/    \1/' "$config_file"
          sed_inplace 's/^#       \(- id: pip-audit\)/      \1/' "$config_file"
          sed_inplace 's/^#         \(name: "ðŸ python Â· pip-audit CVE scan"\)/        \1/' "$config_file"
          sed_inplace 's/^#         args: \["--strict"[^]]*\]/        args: ["--strict", "--progress-spinner", "off", "-r", "requirements-audit.txt"]/' "$config_file"
          echo -e "  ${GREEN}âœ“ Configured pip-audit for uv (-r requirements-audit.txt)${NC}"
          echo -e "  ${YELLOW}  Note: Re-run 'uv export' after dependency changes${NC}"
        else
          echo -e "  ${YELLOW}âš  Could not export uv.lock - pip-audit left disabled${NC}"
          echo -e "  ${YELLOW}  Run: uv export --format requirements.txt -o requirements-audit.txt${NC}"
        fi
      else
        echo -e "  ${YELLOW}âš  uv not found - pip-audit left disabled${NC}"
        echo -e "  ${YELLOW}  Install uv and run: uv export --format requirements.txt -o requirements-audit.txt${NC}"
      fi
      ;;
    pip)
      # Uncomment pip-audit and configure for pip
      sed_inplace 's/^#   \(- repo: https:\/\/github.com\/pypa\/pip-audit\)/  \1/' "$config_file"
      sed_inplace 's/^#     \(rev: v2.10.0\)/    \1/' "$config_file"
      sed_inplace 's/^#     \(hooks:\)/    \1/' "$config_file"
      sed_inplace 's/^#       \(- id: pip-audit\)/      \1/' "$config_file"
      sed_inplace 's/^#         \(name: "ðŸ python Â· pip-audit CVE scan"\)/        \1/' "$config_file"
      if [[ -f "requirements.txt" ]]; then
        sed_inplace 's/^#         args: \["--strict"[^]]*\]/        args: ["--strict", "--progress-spinner", "off", "-r", "requirements.txt"]/' "$config_file"
        echo -e "  ${GREEN}âœ“ Configured pip-audit for pip (-r requirements.txt)${NC}"
      else
        # Scan current environment (no --locked, which requires PEP 751 lockfiles)
        sed_inplace 's/^#         args: \["--strict"[^]]*\]/        args: ["--strict", "--progress-spinner", "off", "."]/' "$config_file"
        echo -e "  ${GREEN}âœ“ Configured pip-audit for pip (current environment)${NC}"
      fi
      ;;
    none)
      # Ensure pip-audit is commented out (in case --force was used on existing config)
      sed_inplace 's/^  \(- repo: https:\/\/github.com\/pypa\/pip-audit\)/#   \1/' "$config_file"
      sed_inplace 's/^    \(rev: v2.10.0\)/#     \1/' "$config_file"
      sed_inplace 's/^    \(hooks:\)/#     \1/' "$config_file"
      sed_inplace 's/^      \(- id: pip-audit\)/#       \1/' "$config_file"
      sed_inplace 's/^        \(name: "ðŸ python Â· pip-audit CVE scan"\)/#         \1/' "$config_file"
      sed_inplace 's/^        \(args: \["--strict"\)/#         \1/' "$config_file"
      echo -e "  ${YELLOW}âš  pip-audit disabled${NC}"
      echo -e "  ${YELLOW}  Run with --pip-audit-pip or --pip-audit-uv to enable${NC}"
      ;;
  esac
}

copy_config() {
  local src="$1"
  local dst="$2"

  if [[ -f "$dst" && "$FORCE" == false ]]; then
    echo -e "  ${YELLOW}âŠ˜ $(basename "$dst") exists (use --force to overwrite)${NC}"
    return
  fi

  if [[ -f "$src" ]]; then
    cp "$src" "$dst"
    echo -e "  ${GREEN}âœ“ $(basename "$dst")${NC}"
  else
    echo -e "  ${RED}âœ— $(basename "$src") not found${NC}"
  fi
}

echo -e "${BLUE}AI Guardrails - Pedantic Code Enforcement${NC}"
echo

# Determine what to copy
if [[ "$COPY_ALL" == true ]]; then
  PROJECT_TYPE="all"
elif [[ -z "$PROJECT_TYPE" ]]; then
  detected=$(detect_project_type)
  if [[ -n "$detected" ]]; then
    # Count detected types
    type_count=$(echo "$detected" | wc -w)
    if [[ $type_count -gt 1 ]]; then
      echo -e "${BLUE}Detected multiple languages:${NC}$detected"
      PROJECT_TYPE="all"
    else
      PROJECT_TYPE=$(echo "$detected" | xargs)
      echo -e "${BLUE}Detected project type:${NC} $PROJECT_TYPE"
    fi
  fi
fi

if [[ -z "$PROJECT_TYPE" ]]; then
  echo -e "${YELLOW}Could not detect project type. Use --type or --all${NC}"
  exit 1
fi

echo

# Always copy .editorconfig
echo -e "${GREEN}Copying configs...${NC}"
copy_config "$CONFIGS_DIR/.editorconfig" ".editorconfig"

# Copy language-specific configs
case "$PROJECT_TYPE" in
  all)
    copy_config "$CONFIGS_DIR/ruff.toml" "ruff.toml"
    copy_config "$CONFIGS_DIR/biome.json" "biome.json"
    copy_config "$CONFIGS_DIR/.clang-format" ".clang-format"
    copy_config "$CONFIGS_DIR/stylua.toml" "stylua.toml"
    copy_config "$CONFIGS_DIR/rustfmt.toml" "rustfmt.toml"
    copy_config "$CONFIGS_DIR/Directory.Build.props" "Directory.Build.props"
    copy_config "$CONFIGS_DIR/.globalconfig" ".globalconfig"
    ;;
  dotnet)
    copy_config "$CONFIGS_DIR/Directory.Build.props" "Directory.Build.props"
    copy_config "$CONFIGS_DIR/.globalconfig" ".globalconfig"
    ;;
  rust)
    copy_config "$CONFIGS_DIR/rustfmt.toml" "rustfmt.toml"
    ;;
  cpp)
    copy_config "$CONFIGS_DIR/.clang-format" ".clang-format"
    ;;
  lua)
    copy_config "$CONFIGS_DIR/stylua.toml" "stylua.toml"
    ;;
  python)
    copy_config "$CONFIGS_DIR/ruff.toml" "ruff.toml"
    ;;
  node)
    copy_config "$CONFIGS_DIR/biome.json" "biome.json"
    ;;
  *)
    echo -e "${RED}Unknown project type: $PROJECT_TYPE${NC}"
    exit 1
    ;;
esac

# Copy pre-commit config
if [[ "$SKIP_PRECOMMIT" == false ]]; then
  echo
  echo -e "${GREEN}Setting up pre-commit...${NC}"

  # Track whether we should configure pip-audit (only if we copy our template)
  CONFIGURE_PIP_AUDIT=false
  if [[ ! -f ".pre-commit-config.yaml" || "$FORCE" == true ]]; then
    CONFIGURE_PIP_AUDIT=true
  fi

  copy_config "$TEMPLATES_DIR/pre-commit-config.yaml" ".pre-commit-config.yaml"

  # Auto-detect and configure pip-audit (only if we copied our template)
  if [[ "$CONFIGURE_PIP_AUDIT" == true && -f ".pre-commit-config.yaml" ]]; then
    if [[ "$PIP_AUDIT_MODE" == "auto" ]]; then
      PIP_AUDIT_MODE=$(detect_python_deps)
    fi
    configure_pip_audit "$PIP_AUDIT_MODE"
  fi

  # Install pre-commit hooks if available
  if command -v pre-commit &>/dev/null; then
    if [[ -d ".git" ]]; then
      if pre-commit install 2>/dev/null; then
        echo -e "  ${GREEN}âœ“ pre-commit hooks installed${NC}"
      fi
    fi
  else
    echo -e "  ${YELLOW}Note: Install pre-commit to activate hooks:${NC}"
    echo "    pip install pre-commit && pre-commit install"
  fi
fi

# Add .ai-guardrails to gitignore
if [[ -d ".git" ]]; then
  if ! grep -q "^\.ai-guardrails" .gitignore 2>/dev/null; then
    echo ".ai-guardrails/" >>.gitignore
    echo -e "  ${GREEN}âœ“ Added .ai-guardrails/ to .gitignore${NC}"
  fi
fi

echo
echo -e "${GREEN}Pedantic code enforcement initialized!${NC}"
echo
echo "Configs installed enforce:"
echo "  â€¢ Consistent formatting (EditorConfig + language formatters)"
echo "  â€¢ Required type annotations"
echo "  â€¢ Required documentation (docstrings, XML comments)"
echo "  â€¢ Strict static analysis (warnings as errors)"
echo
echo "Run pre-commit on all files:"
echo "  pre-commit run --all-files"
