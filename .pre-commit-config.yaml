# =============================================================================
# STRICT Pre-Commit Configuration for AI-Driven Development
# =============================================================================
# AI Guardrails - Multi-language hooks
# All checks run in strictest mode. No exceptions. No bypasses.
# AI agents need guardrails - this is the fence.
#
# Languages: Python, TypeScript, C#/.NET, Shell, Markdown
# Dormant hooks auto-skip if no matching files exist.
# =============================================================================

fail_fast: true
default_language_version:
  python: python3.12
  node: "20.11.0"

repos:
  # ===========================================================================
  #  FORMAT & STAGE - Auto-fix before checks (skipped in CI)
  # ===========================================================================

  - repo: local
    hooks:
      - id: format-and-stage
        name: " format 路 auto-fix and stage"
        entry: lib/hooks/format-and-stage.sh
        language: script
        always_run: true
        pass_filenames: false

  # ===========================================================================
  #  SECURITY - CRITICAL (runs first, fails fast)
  # ===========================================================================

  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.21.2
    hooks:
      - id: gitleaks
        name: " security 路 gitleaks - detect secrets"

  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        name: " security 路 detect-secrets - enhanced"
        args: ["--baseline", ".secrets.baseline"]
        exclude: package-lock\.json|\.secrets\.baseline

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: detect-private-key
        name: " security 路 detect private keys"

  - repo: https://github.com/semgrep/semgrep
    rev: v1.149.0
    hooks:
      - id: semgrep
        name: " security 路 semgrep SAST scan"
        args: ["--config", "auto", "--error"]
        exclude: ^tests/

  # ===========================================================================
  #  COMMIT MESSAGE - CONVENTIONAL COMMITS REQUIRED
  # ===========================================================================

  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v4.3.0
    hooks:
      - id: conventional-pre-commit
        name: " commit 路 conventional commit format"
        stages: [commit-msg]
        args: [feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert]

  # ===========================================================================
  #  SPELLING - TYPO DETECTION
  # ===========================================================================

  - repo: https://github.com/codespell-project/codespell
    rev: v2.4.1
    hooks:
      - id: codespell
        name: " spelling 路 codespell typo check"
        args: ["--check-filenames"]
        exclude: ^(poetry\.lock|package-lock\.json|\.secrets\.baseline)$

  # ===========================================================================
  #  PYTHON - STRICT MODE (dormant if no Python files)
  # ===========================================================================

  # Ruff - Fast linter (replaces flake8, isort, pyupgrade, etc.)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.6
    hooks:
      - id: ruff
        name: " python 路 ruff lint (pedantic)"
        args: ["--no-fix"]
      - id: ruff-format
        name: " python 路 ruff format"

  # Bandit - Security linter for Python
  - repo: https://github.com/PyCQA/bandit
    rev: 1.8.0
    hooks:
      - id: bandit
        name: " python 路 bandit security scan"
        args: ["-ll", "-ii", "-r"]
        exclude: ^tests/

  # pip-audit: Disabled (template repository has no Python dependencies)
  # Configured automatically by ai-guardrails-init in target projects
  #
  # - repo: https://github.com/pypa/pip-audit
  #   rev: v2.10.0
  #   hooks:
  #     - id: pip-audit
  #       name: " python 路 pip-audit CVE scan"
  #       args: ["--strict", "--progress-spinner", "off"]

  # ===========================================================================
  #  TYPESCRIPT/JAVASCRIPT - STRICT MODE (dormant if no TS/JS files)
  # ===========================================================================

  # Biome - Fast linter + formatter (replaces ESLint + Prettier)
  - repo: https://github.com/biomejs/pre-commit
    rev: "v0.6.1"
    hooks:
      - id: biome-check
        name: " typescript 路 biome lint+format (strict)"
        additional_dependencies: ["@biomejs/biome@1.9.4"]
        args: [
          "--error-on-warnings",
          "--diagnostic-level=info",
        ]

  # TypeScript type checking (local hook)
  - repo: local
    hooks:
      - id: tsc
        name: " typescript 路 tsc type check (strict)"
        entry: npx tsc
        args: ["--noEmit", "--strict", "--skipLibCheck"]
        language: system
        types: [ts, tsx]
        pass_filenames: false

  # ===========================================================================
  #  C# / .NET - STRICT MODE (dormant if no .cs files)
  # ===========================================================================

  - repo: local
    hooks:
      # dotnet format - Code style enforcement
      - id: dotnet-format
        name: " csharp 路 dotnet format (strict)"
        entry: dotnet format
        args: [
          "--verify-no-changes",
          "--verbosity", "normal",
          "--severity", "info",
        ]
        language: system
        types: [c#]
        pass_filenames: false

      # dotnet build - Compilation check (catches errors + warnings as errors)
      - id: dotnet-build
        name: " csharp 路 dotnet build (warnings as errors)"
        entry: dotnet build
        args: [
          "--no-restore",
          "-warnaserror",
          "-c", "Release",
        ]
        language: system
        types: [c#]
        pass_filenames: false

  # ===========================================================================
  #  SHELL - STRICT MODE
  # ===========================================================================

  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        name: " shell 路 shellcheck lint"
        args: ["--severity=info"]

  # Shell formatting
  - repo: https://github.com/scop/pre-commit-shfmt
    rev: v3.10.0-1
    hooks:
      - id: shfmt
        name: " shell 路 shfmt format check"
        args: ["-i", "2", "-ci", "-bn", "-d"]

  # ===========================================================================
  #  MARKDOWN - STRICT MODE
  # ===========================================================================

  - repo: https://github.com/DavidAnson/markdownlint-cli2
    rev: v0.17.2
    hooks:
      - id: markdownlint-cli2
        name: " markdown 路 markdownlint"

  # ===========================================================================
  #  CONFIG & DATA VALIDATION
  # ===========================================================================

  - repo: https://github.com/python-jsonschema/check-jsonschema
    rev: 0.30.0
    hooks:
      - id: check-github-workflows
        name: " github 路 validate workflow files"
      - id: check-github-actions
        name: " github 路 validate action files"

  # TOML validation and formatting
  - repo: https://github.com/ComPWA/taplo-pre-commit
    rev: v0.9.3
    hooks:
      - id: taplo-format
        name: " toml 路 taplo format check"
        args: ["--check"]

  # ===========================================================================
  #  UNIVERSAL QUALITY CHECKS
  # ===========================================================================

  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      # Whitespace & formatting
      - id: trailing-whitespace
        name: " format 路 trailing whitespace"
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
        name: " format 路 end of file fixer"
      - id: mixed-line-ending
        name: " format 路 mixed line endings"
        args: [--fix=lf]

      # Syntax validation
      - id: check-yaml
        name: " syntax 路 check yaml"
        args: [--unsafe]
      - id: check-json
        name: " syntax 路 check json"
      - id: check-toml
        name: " syntax 路 check toml"
      - id: check-xml
        name: " syntax 路 check xml"

      # Git hygiene
      - id: check-merge-conflict
        name: " git 路 check merge conflicts"
      - id: check-added-large-files
        name: " git 路 check large files"
        args: [--maxkb=500]
      - id: no-commit-to-branch
        name: " git 路 no commit to main"
        args: [--branch=main, --branch=master]

      # File checks
      - id: check-case-conflict
        name: " files 路 case conflict"
      - id: check-symlinks
        name: " files 路 broken symlinks"
      - id: check-executables-have-shebangs
        name: " files 路 executables have shebangs"
      - id: check-shebang-scripts-are-executable
        name: " files 路 shebang scripts executable"

      # Python-specific
      - id: check-ast
        name: " python 路 check ast syntax"
      - id: debug-statements
        name: " python 路 no debug statements"
      - id: name-tests-test
        name: " python 路 test files named test_*"
        args: [--pytest-test-first]

# =============================================================================
# CI Note: This config is also used in GitHub Actions
# Install: pip install pre-commit && pre-commit install
# Run all: pre-commit run --all-files
#
# Dormant hooks (TS, C#, Python) auto-skip if no matching files exist.
# =============================================================================
