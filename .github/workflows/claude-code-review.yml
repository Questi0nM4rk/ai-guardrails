name: Claude Architecture & Spec Review

on:
  # Trigger via /claude-review comment (primary manual trigger)
  issue_comment:
    types: [created]

  # Trigger on PR events when label is present
  # Note: "labeled" action incompatible with track_progress, use /claude-review comment
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    # Run if:
    # 1. Comment "/claude-review" on a PR by trusted user (OWNER/MEMBER/COLLABORATOR), OR
    # 2. PR has "claude-review" label (and not draft)
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/claude-review') &&
       contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association)) ||
      (github.event_name == 'pull_request' &&
       github.event.pull_request.draft == false &&
       contains(github.event.pull_request.labels.*.name, 'claude-review'))

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    # Prevent parallel runs on same PR
    concurrency:
      group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: true

    steps:
      # Get PR info for comment-triggered runs (supports fork PRs)
      - name: Get PR details (comment trigger)
        if: github.event_name == 'issue_comment'
        id: pr-info
        run: |
          PR_DATA=$(gh pr view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json headRefOid,headRepository,headRepositoryOwner,number,title,author)
          echo "head_sha=$(echo "$PR_DATA" | jq -r '.headRefOid')" >> $GITHUB_OUTPUT
          echo "head_repo=$(echo "$PR_DATA" | jq -r '.headRepositoryOwner.login + "/" + .headRepository.name')" >> $GITHUB_OUTPUT
          echo "number=$(echo "$PR_DATA" | jq -r '.number')" >> $GITHUB_OUTPUT
          echo "title=$(echo "$PR_DATA" | jq -r '.title')" >> $GITHUB_OUTPUT
          echo "author=$(echo "$PR_DATA" | jq -r '.author.login')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ github.event.pull_request.head.repo.full_name || steps.pr-info.outputs.head_repo }}
          ref: ${{ github.event.pull_request.head.sha || steps.pr-info.outputs.head_sha }}

      - name: Claude Architecture & Spec Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true

          prompt: |
            # ARCHITECTURE & SPEC REVIEW

            Repository: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number || steps.pr-info.outputs.number }}
            Title: ${{ github.event.pull_request.title || steps.pr-info.outputs.title }}
            Author: ${{ github.event.pull_request.user.login || steps.pr-info.outputs.author }}

            ## YOUR ROLE

            You are the ARCHITECTURE & SPEC reviewer. CodeRabbit handles code quality.

            Your focus:
            - Business requirements & intent
            - Architectural decisions & patterns
            - Spec compliance & documentation
            - High-level PR overview
            - Code duplication: repeated logic that should be extracted into shared functions or utilities
            - Clean code: poor naming, functions doing too much, unclear intent, dead code
            - Improper method usage: reimplementing what the standard library or framework already provides
            - Outdated patterns: deprecated APIs, old idioms â€” enforce modern language usage

            NOT your focus (CodeRabbit handles):
            - Code style, formatting
            - Performance micro-optimizations

            ## REVIEW PROCESS

            1. First, read `docs/specs/review-checklist.md` for requirements
            2. Fetch the PR details with `gh pr view ${{ github.event.pull_request.number || steps.pr-info.outputs.number }}`
            3. Get the diff with `gh pr diff ${{ github.event.pull_request.number || steps.pr-info.outputs.number }}`
            4. Review against the checklist
            5. Post your review as a PR comment

            ## REVIEW CHECKLIST

            ### 1. PR Structure (REQUIRED)

            Check the PR body for:
            - **Intent**: Why is this change needed?
            - **Scope**: What components are affected?
            - **Acceptance Criteria**: How do we know it's done?
            - **Test Plan**: How to verify it works?

            If ANY are missing -> REQUEST CHANGES with template.

            ### 2. Architecture Compliance

            - Correct layering (API -> Service -> Repo)
            - No circular dependencies
            - Proper separation of concerns
            - Interface boundaries respected

            ### 3. Spec Alignment

            - Changes match documented specs in `docs/specs/`
            - If behavior changes, spec is updated
            - No undocumented breaking changes

            ### 4. Documentation

            - README updated for new features
            - API docs reflect changes
            - Migration guide for breaking changes

            ## OUTPUT FORMAT

            Post a PR comment using `gh pr comment` with this format:

            ```
            ## Architecture & Spec Review

            ### Overview
            [2-3 sentence summary of what this PR does at a high level]

            ### Checklist Results

            | Category | Status | Notes |
            |----------|--------|-------|
            | PR Structure | [status] | ... |
            | Architecture | [status] | ... |
            | Spec Compliance | [status] | ... |
            | Documentation | [status] | ... |

            ### Issues Found
            [List specific issues if any]

            ### Recommendation
            [APPROVE / APPROVE with suggestions / REQUEST CHANGES]
            ```

            ## ENFORCEMENT

            If PR body is missing required sections, include this template in your comment:

            ---
            **Please update your PR description with:**

            ### Intent
            [Why is this change needed? What problem does it solve?]

            ### Scope
            [What components/files are affected? What's NOT changing?]

            ### Acceptance Criteria
            - [ ] Criterion 1
            - [ ] Criterion 2

            ### Test Plan
            [How to verify this works?]
            ---

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr view:*),Bash(gh pr diff:*),Bash(git diff:*),Bash(git log:*),Read,Glob,Grep"
            --max-turns 25
