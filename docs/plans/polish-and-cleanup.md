# Plan: Complete Polish, Cleanup & Hardening

## Status: COMPLETE

All 5 phases executed via PRs #20–#24.

**Final state**: 400 pytest tests, 90% coverage, zero bats, pyright clean,
unified `ai-guardrails` CLI documented.

## Overview

The `feat/python-rewrite` PR (merged as #19) converted all bash hook logic and
CLI scripts into a proper `guardrails` Python package. This plan covers
everything needed to make the project production-quality.

**Current state** (pre-polish): 3725 lines of Python, 1799 lines of bats tests (to be
replaced), 211 pytest tests at 94% coverage (but only because 7 modules are
excluded from measurement).

## GetShitDone Framework

Each phase is designed to be completed by a single subagent in one shot
(< 200k tokens). The orchestrator holds context and validates between phases.

---

## Phase 1: Dead Code Removal & File Renames -- DONE (PR #20)

**Branch**: `feat/polish-phase1`

1. **Delete `bin/ai-hooks-init`** (181 lines of old bash)
   - Its functionality is fully covered by `ai-guardrails init`
   - Remove from `lib/installers/core.py` BIN_SCRIPTS list
   - Update any references in README.md or templates

2. **Rename test files** to match new module names
   - `tests/test_assemble_precommit.py` → `tests/test_assemble.py`
   - `tests/test_coderabbit_parser.py` → `tests/test_coderabbit.py`
   - Update docstrings inside each file

3. **Update `docs/plans/bin-scripts-conversion.md`** — mark as COMPLETE

4. **Clean up `conftest.py`** — verify comment is current

5. **Remove dead ruff ignores** from `pyproject.toml`
   - Run `ruff check lib/python/ --statistics` to find which rules actually trigger
   - Remove any per-file-ignores that are no longer needed

---

## Phase 2: Migrate Bats to Pytest (Assembly, Detection, Install) -- DONE (PR #21)

**Branch**: `feat/polish-phase2`

Bats tests exist for functionality that's now Python. Migrate them to pytest.

1. **Migrate `test_assembly.bats` (277 lines) → enhance `test_assemble.py`**
   - The existing pytest file already covers most cases
   - Port any bats-only scenarios (CLI invocation, output format)
   - Delete `test_assembly.bats`

2. **Migrate `test_detection.bats` (290 lines) → `tests/test_detection.py`**
   - Tests language detection from file markers (pyproject.toml → python, etc.)
   - Port to pytest using `tmp_path` fixture and `detect_languages()`
   - Delete `test_detection.bats`

3. **Migrate `test_install.bats` + `test_install_group_a.bats` (369 lines) → enhance `test_installers.py`**
   - Tests `install.py` CLI flags
   - Port to pytest (may need mocking since pyinfra is heavy)
   - Delete both bats files

4. **Delete `test_init.bats` (264 lines)**
   - All init functionality will be tested via pytest in Phase 3
   - The bats tests test the bash shim, not the Python logic

5. **Update `tests/bats/helpers.bash`**
   - Remove `run_init`, `INIT_SCRIPT` (no longer used)
   - Remove `run_assemble`, `ASSEMBLE_MODULE` (bats assembly tests deleted)

---

## Phase 3: Write Tests for Untested Python Modules -- DONE (PR #22)

**Branch**: `feat/polish-phase3`

These modules have 0% coverage and are excluded from measurement. This phase
writes proper pytest coverage and removes the exclusions.

1. **Hook tests** — one file per hook module (implementation split from original plan)
   - `tests/test_hook_dangerous_cmd.py` — test `--no-verify` detection
   - `tests/test_hook_suppress_comments.py` — test pattern detection, allowlists
   - `tests/test_hook_config_ignore.py` — mock git diff, test ignore-pattern matching
   - `tests/test_hook_protect_configs.py` — test JSON stdin/stdout protocol
   - `tests/test_hook_format_stage.py` — mock formatters, test re-staging logic
   - `tests/test_hooks_utils.py` — test `has_autogenerated_header()`

2. **`tests/test_cli.py`** — test CLI arg parsing
   - Test each subcommand dispatches correctly (mock the handler)
   - Test `--version`
   - Test missing subcommand error

3. **`tests/test_paths.py`** — test `_paths.py`
   - Test `find_configs_dir()`, `find_templates_dir()`, `find_lib_dir()`
   - Test fallback to `~/.ai-guardrails/`
   - Test `find_base_config()` precedence

4. **`tests/test_generate.py`** — test generate module
   - Test `run_generate_configs()` end-to-end
   - Test `--dry-run` and `--check` modes
   - Test error handling (missing registry, invalid registry)

5. **`tests/test_coderabbit_review.py`** — test `run_review()` (new file, not enhancement)
   - Mock `subprocess.run` for `gh api` calls
   - Test filtering by severity
   - Test error handling (gh not installed, API failures)

6. **Note**: `test_init.py` was deferred — `init.py` remains in coverage omit

7. **Remove coverage omit entries** from `pyproject.toml`
   - Remove all entries except `init.py` and `__main__.py` (those remain until `test_init.py` is added)
   - Track remaining omit removals in Phase 5 once init is fully tested
   - Verify `--cov-fail-under=85` still passes

---

## Phase 4: Delete Remaining Bats, Add Pyright, Update CI -- DONE (PR #23)

**Branch**: `feat/polish-phase4`

1. **Migrate remaining bats hook tests to pytest**
   - `test_detect_config_ignore_edits.bats` (218 lines) → already covered by `test_hooks.py` from Phase 3
   - `test_protect_generated_configs.bats` (268 lines) → already covered by `test_hooks.py` from Phase 3
   - Verify pytest tests cover all bats scenarios, then delete both files

2. **Delete bats infrastructure**
   - Delete `tests/bats/` directory entirely
   - Delete bats CI job from `.github/workflows/test.yml`
   - Remove `pyyaml tomli-w tomlkit` from bats CI deps (no longer needed)

3. **Add pyright type checking**

   ```toml
   [tool.pyright]
   include = ["lib/python/guardrails"]
   pythonVersion = "3.11"
   typeCheckingMode = "standard"
   ```

   - Fix all type errors
   - Add pyright to CI (`check.yml` lint job)

4. **Update CI workflow**
   - Remove bats job from `test.yml`
   - Add pyright step to lint job in `check.yml`
   - Clean up any remaining old module path references

---

## Phase 5: Documentation & Final Polish -- DONE (PR #24)

**Branch**: `feat/polish-phase5`

1. **Update README.md**
   - Document `ai-guardrails` unified CLI (init/generate/review)
   - Remove references to old separate scripts
   - Update installation instructions

2. **Update `docs/plans/bin-scripts-conversion.md`** — mark COMPLETE with summary

3. **Update this plan** — mark all sections DONE

4. **Compact the codebase**
   - Run `vulture lib/python/` to find dead code
   - Remove any unused imports (`ruff check --select F401`)
   - Consolidate duplicate logic across modules
   - Ensure consistent error handling (all hooks use same exit codes)

5. **Final coverage audit**
   - Run coverage report, identify any remaining gaps
   - Ensure 85%+ with NO omit entries
   - Target 90%+ if feasible

---

## Execution Checklist

| Phase | Branch | Key Deliverable | PR |
|-------|--------|----------------|----|
| 1 | `feat/polish-phase1` | Dead code gone, files renamed | #20 |
| 2 | `feat/polish-phase2` | Assembly/detection/install bats → pytest | #21 |
| 3 | `feat/polish-phase3` | Full test coverage, no omit entries | #22 |
| 4 | `feat/polish-phase4` | Zero bats, pyright clean, CI updated | #23 |
| 5 | `feat/polish-phase5` | Docs updated, dead code removed, 90%+ coverage | #24 |

**Actual execution**: Each phase was implemented as a separate PR (#20–#24)
on stacked branches. Phases were developed sequentially using git worktrees.
